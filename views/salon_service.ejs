<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= salon.shopname %></title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="/Stylesheets/hospital_service.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

</head>

<body>

<div class="card">
  <%
    const waitTime = queueStats.estimatedWait || 0;
    const hours = Math.floor(waitTime / 60);
    const minutes = waitTime % 60;
    let formattedTime = hours > 0
      ? `${hours} hr${minutes > 0 ? ' ' + minutes + ' min' : ''}`
      : `${minutes} min`;

    const selectedRange = salon.adminId?.estimatedWaitTimeRange || "0‚Äì10 min";
  %>

  <!-- ‚úÖ Queue Stats Section -->
  <div class="status">
    <div>
      <div><i class="fas fa-ticket-alt"></i> Current Token<span class="blinking-dot"></span></div>
      <div class="status-value <%= queueStats.currentToken === 0 ? 'no-token' : '' %>">
        <%= queueStats.currentToken && queueStats.currentToken !== 0 ? queueStats.currentToken : "None" %>
      </div>
    </div>
    <div>
      <div><i class="fas fa-user-friends"></i> People in Queue</div>
      <div class="status-value" id="queuePos"><%= queueStats.peopleInQueue %></div>
    </div>
    <div>
      <div><i class="fas fa-clock"></i> Estimated Wait</div>
      <div class="status-value" id="waitTime">
        <%= formattedTime %> <span style="font-size: 13px;">(<%= selectedRange %>)</span>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Hospital Info Card -->
  <div class="card hospital-info">
    <h3>
      <%= salon.shopname %>
      <span class="rating">
        ‚≠ê <%= salon.rating || "4.8" %>
        <span>(<%= salon.reviewCount || "12 reviews" %>)</span>
      </span>
    </h3>

    <div class="info-detail">
      <strong>Address:</strong> <%= salon.shopaddress %><br><br>
      <strong>Admin Name:</strong> <%= salon.name || "N/A" %><br><br>
      <strong>Phone:</strong> <%= salon.phone %><br><br>

      <div id="distance" data-lat="<%= salon.lat %>" data-lng="<%= salon.lng %>">
        <strong>Distance:</strong>
        <span style="color: red;">(From Your current location):</span>
        <span id="distanceValue">Calculating...</span><br><br>
      </div>

      <%
        const [min, max] = selectedRange.split("‚Äì").map(s => parseInt(s));
        const avg = Math.round((min + max) / 2);
        const avgWaitTime = salon.tokens && salon.tokens.length ? salon.tokens.length * avg : avg;
      %>
      <strong>Average Wait Time:</strong> <%= avgWaitTime %> minutes<br>
      <strong>Admin Selected Range:</strong> <%= selectedRange %><br>
    </div>

    <!-- ‚úÖ Specialty Tags -->
    <div class="tags">
      <% if (salon.specialties) { %>
        <% salon.specialties.split(',').forEach(tag => { %>
          <div class="tag"><%= tag.trim() %></div>
        <% }) %>
      <% } else { %>
        <div class="tag">General Services</div>
      <% } %>
    </div>
  </div>

  <!-- ‚úÖ Live Updates Section -->
  <div class="live-updates" id="liveUpdates">
    <% updates.forEach(update => { %>
      <div class="token-update update-<%= update.type %>">
        <i class="fas <%= update.type === 'now' ? 'fa-bell' : update.type === 'completed' ? 'fa-check' : 'fa-plus-circle' %>"></i>
        <%= update.message %>
      </div>
    <% }); %>
  </div>
</div>


  <div class="card form-book-section">
    <h3>Book a Token</h3><br>
    <p class="last-update">Last Update: <span><%= lastUpdated %></span></p><br>

    <div class="form-container">
      <form autocomplete="off" method="POST" action="/salon/<%= salon._id %>/book-token" class="form-box">
        <% if (flash.error && flash.error.length > 0) { %>
          <div class="flash-message error">
            <%= flash.error[0] %>
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
          </div>
        <% } %>

        <div class="form-group">
          <label for="name"><i class="fas fa-user"></i> Full Name</label>
          <input type="text" id="name" name="name" placeholder="Enter your full name" required />
        </div>

        <div class="form-group">
          <label for="phone"><i class="fas fa-phone"></i> Phone Number</label>
          <input type="tel" id="phone" name="phone" placeholder="Enter your phone number" required />
        </div>

        <button type="submit" class="btn book-btn">Book Token</button>
      </form>

      <form method="POST" action="/salon/<%= salon._id %>/delete-token" class="form-box">
        <h4>Delete Token</h4>

        <% if (flash.success && flash.success.length > 0) { %>
          <div class="flash-message success">
            <%= flash.success[0] %>
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
          </div>
        <% } %>

        <% if (flash.deleteError && flash.deleteError.length > 0) { %>
          <div class="flash-message error">
            <%= flash.deleteError[0] %>
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
          </div>
        <% } %>

        <div class="form-group">
          <label for="deletePhone"><i class="fas fa-phone-slash"></i> Phone Number</label>
          <input type="tel" id="deletePhone" name="phone" placeholder="Enter phone number to delete token" required />
        </div>

        <button type="submit" class="btn delete-btn">Delete Token</button>
      </form>
    </div>



    <% if (userHasActiveToken) { %>
  <div class="status-box">
    <h4>Your Current Status</h4>
    <p><i class="fas fa-clock"></i> Estimated Wait:
      <span id="waitTime">
        ~<%= userQueueStats.estimatedWait >= 60 
          ? Math.floor(userQueueStats.estimatedWait / 60) + " hr " + (userQueueStats.estimatedWait % 60) + " min" 
          : userQueueStats.estimatedWait + " min" %>
      </span>
    </p><br>
    <p><i class="fas fa-users"></i> Queue Position:
      <span id="queuePos">#<%= userQueueStats.peopleInQueue %></span>
    </p>
  </div>
<% } %>

  </div>

  <% const googleEmbedUrl = `https://www.google.com/maps?q=${salon.lat},${salon.lng}&z=17&output=embed`; %>
  <% const googleMapLink = `https://www.google.com/maps/dir/?api=1&destination=${salon.lat},${salon.lng}`; %>

  <div class="map-section">
    <div class="header"><i class="fas fa-map-marker-alt"></i> Find Us on Google Maps</div>
    <p>
      Click below to navigate to <strong><%= salon.shopname %></strong>. Use Google Maps directions for the fastest route.
    </p>

    <div class="map-container">
      <iframe
        src="<%= googleEmbedUrl %>"
        width="100%"
        height="300"
        style="border:0; border-radius: 8px;"
        allowfullscreen
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade">
      </iframe>
    </div>

    <div style="text-align: center; margin-top: 10px;">
      <a class="btn btn-primary" href="<%= googleMapLink %>" target="_blank" style="color: #2563eb; font-weight: 500;">
        üöó Get Directions
      </a>
    </div>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Custom JS -->
  <script src="/javascripts/salon_service.js"></script>
</body>
</html>
